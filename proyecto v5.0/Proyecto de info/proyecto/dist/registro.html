<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Registro de Usuario</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script type="module" crossorigin src="/assets/modulepreload-polyfill-B5Qt9EMX.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/main-CQnBzoBq.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
</head>
<body class="bg-gray-600 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
      <h2 class="text-2xl font-bold text-center text-gray-800 mb-8">Registro de Usuario</h2>
      
      <form class="space-y-6" id="registration-form" action="/register" method="POST">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700">Correo electrónico</label>
          <input type="email" id="email" name="email" required 
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
        </div>

        <div>
          <label for="name" class="block text-sm font-medium text-gray-700">Nombre de usuario</label>
          <input type="text" id="name" name="name" required 
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
          <input type="password" id="password" name="password" required 
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                 <input type="checkbox" onclick="myFunction1()">Mostrar contraseña
          <div id="passwordSecurityErrorMessages" class="text-red-500 text-sm mt-1"></div>
        </div>
 
        <div>
            <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirmar Contraseña</label>
            <input type="password" id="confirm-password" name="confirm-password" required 
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                   <input type="checkbox" onclick="myFunction2()">Mostrar contraseña
            <div id="passwordMismatchError" class="text-red-500 text-sm mt-1"></div>
          </div>

        <div class="flex justify-center">
          <button type="submit" 
                  class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            Enviar
          </button>
        </div>
      </form>
 
      <div class="mt-6" id="loginUser">
        <div class="border-t border-gray-200 pt-6">
          <h3 class="login-message block text-sm font-medium text-gray-700 text-center">¿Ya tiene cuenta?</h3>
          <div class="flex justify-center pt-6">
            <button type="button" 
                    class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                      <a href="index.html" class="text-sm text-white">Iniciar sesión</a>  
            </button>
          </div>
        </div>
      </div>

    <script>

        function validatePassword(password) {
            const errors = [];

            
            if (password.length <= 8) {
                errors.push('La contraseña debe tener al menos 9 caracteres.');
            }

            
            if (!/[A-Z]/.test(password)) {
                errors.push('La contraseña debe contener al menos una letra mayúscula.');
            }

            
            if (!/[^0-9a-zA-Z]/.test(password)) {
                errors.push('La contraseña debe contener al menos un carácter especial (ej. !, @, #, $, %).');
            }

            
            if (!/[0-9]/.test(password)) {
                errors.push('La contraseña debe contener al menos un número.');
            }

            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }


        document.getElementById("registration-form").addEventListener("submit", async function(event) {
            event.preventDefault(); 

            const passwordInput = document.getElementById("password");
            const confirmPasswordInput = document.getElementById("confirm-password");
            const passwordSecurityErrorMessagesDiv = document.getElementById("passwordSecurityErrorMessages");
            const passwordMismatchErrorDiv = document.getElementById("passwordMismatchError");

            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            
            passwordSecurityErrorMessagesDiv.innerHTML = '';
            passwordMismatchErrorDiv.innerHTML = '';

            let allValid = true;

          
            if (password !== confirmPassword) {
                passwordMismatchErrorDiv.innerHTML = '<p>• Las contraseñas no coinciden.</p>';
                Swal.fire({
                    icon: 'error',
                    title: '¡Error de Contraseña!',
                    text: 'Las contraseñas no coinciden. Por favor, asegúrate de que sean iguales.',
                    confirmButtonText: 'OK',
                    showClass: { popup: 'animate__animated animate__shakeX' },
                    hideClass: { popup: 'animate__animated animate__fadeOutUp' }
                });
                allValid = false;
            }

            
            const securityValidationResult = validatePassword(password);
            if (!securityValidationResult.isValid) {
                securityValidationResult.errors.forEach(error => {
                    const p = document.createElement('p');
                    p.textContent = `• ${error}`;
                    passwordSecurityErrorMessagesDiv.appendChild(p);
                });
                allValid = false;
            }

            
            if (!allValid) {
                
                passwordInput.focus();
                return; 
            }

            
            const username = document.getElementById("name").value; 
            const email = document.getElementById("email").value;
            

            try {
                
                const response = await fetch("/register", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ text: username, email, password }) 
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Registro Exitoso!',
                        text: data.message || 'Tu cuenta ha sido creada. ¡Bienvenido!', 
                        timer: 2000,
                        timerProgressBar: true,
                        showClass: { popup: 'animate__animated animate__fadeInDown' },
                        hideClass: { popup: 'animate__animated animate__fadeOutUp' },
                        didClose: () => {
                            window.location.href = '/index.html';
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error en el Registro',
                        text: data.message || 'Hubo un problema al registrarte. Por favor, inténtalo de nuevo.',
                        confirmButtonText: 'Entendido',
                        showClass: { popup: 'animate__animated animate__shakeX' },
                        hideClass: { popup: 'animate__animated animate__fadeOutUp' }
                    });
                }

            } catch (error) {
                console.error("Error de red o del servidor:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Conexión',
                    text: 'No se pudo conectar con el servidor. Por favor, verifica tu conexión o inténtalo de nuevo.',
                    confirmButtonText: 'Cerrar',
                    showClass: { popup: 'animate__animated animate__zoomIn' },
                    hideClass: { popup: 'animate__animated animate__zoomOut' }
                });
            }
        });

        
        document.getElementById("password").addEventListener('input', () => {
            const passwordInput = document.getElementById("password");
            const passwordSecurityErrorMessagesDiv = document.getElementById("passwordSecurityErrorMessages");
            const password = passwordInput.value;
            const validationResult = validatePassword(password);

            passwordSecurityErrorMessagesDiv.innerHTML = '';

            if (!validationResult.isValid) {
                validationResult.errors.forEach(error => {
                    const p = document.createElement('p');
                    p.textContent = `• ${error}`;
                    passwordSecurityErrorMessagesDiv.appendChild(p);
                });
            }
        });

    </script>
    <script>
        function myFunction1() {
        var x = document.getElementById("password");
        if (x.type === "password") {
            x.type = "text";
        } else {
            x.type = "password";
        }
        }
        function myFunction2() {
        var x = document.getElementById("confirm-password");
        if (x.type === "password") {
            x.type = "text";
        } else {
            x.type = "password";
        }
        }
    </script>
</body>
</html>