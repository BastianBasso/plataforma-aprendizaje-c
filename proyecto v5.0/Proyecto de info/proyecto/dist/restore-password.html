<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer contraseña</title>
    <link rel="stylesheet" crossorigin href="/assets/main-CQnBzoBq.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    </head>
<body class="bg-gray-600 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-8">Restablecer contraseña</h2>
        
        <form id="restorePasswordForm" class="space-y-6" action="/restore-password" method="POST">
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Nueva contraseña</label>
                <input type="password" id="password" name="password" required 
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <div id="passwordSecurityErrorMessages" class="text-red-500 text-sm mt-1"></div>
            </div>

            <div>
                <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirmar contraseña</label>
                <input type="password" id="confirm-password" name="confirm-password" required 
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <div id="passwordMismatchError" class="text-red-500 text-sm mt-1"></div>
            </div>

            <div class="text-center">
                <button id="login" type="submit" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Enviar
                </button>
            </div>
        </form>
    </div>

    <script>

        function validatePassword(password) {
            const errors = [];

            
            if (password.length <= 8) {
                errors.push('La contraseña debe tener al menos 9 caracteres.');
            }

            
            if (!/[A-Z]/.test(password)) {
                errors.push('La contraseña debe contener al menos una letra mayúscula.');
            }

            
            if (!/[^0-9a-zA-Z]/.test(password)) {
                errors.push('La contraseña debe contener al menos un carácter especial (ej. !, @, #, $, %).');
            }

           
            if (!/[0-9]/.test(password)) {
                errors.push('La contraseña debe contener al menos un número.');
            }

            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Acceso',
                    text: 'No se encontró un token de restablecimiento válido. Por favor, usa el enlace completo del correo electrónico.',
                    confirmButtonText: 'Ir a Olvidé Contraseña',
                    allowOutsideClick: false,
                    didClose: () => {
                        window.location.href = '/forgot-password.html';
                    }
                });
                return;
            }

            const form = document.getElementById('restorePasswordForm');
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const passwordSecurityErrorMessagesDiv = document.getElementById("passwordSecurityErrorMessages");
            const passwordMismatchErrorDiv = document.getElementById("passwordMismatchError");

            

            if (form) {
                form.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    const newPassword = passwordInput.value;
                    const confirmPassword = confirmPasswordInput.value;

                    
                    passwordSecurityErrorMessagesDiv.innerHTML = '';
                    passwordMismatchErrorDiv.innerHTML = '';

                    let allValid = true; 

                    
                    if (newPassword !== confirmPassword) {
                        passwordMismatchErrorDiv.innerHTML = '<p>• Las contraseñas no coinciden.</p>';
                        Swal.fire({
                            icon: 'error',
                            title: '¡Error de Contraseña!',
                            text: 'Las contraseñas no coinciden. Por favor, asegúrate de que sean iguales.',
                            confirmButtonText: 'OK',
                            showClass: { popup: 'animate__animated animate__shakeX' },
                            hideClass: { popup: 'animate__animated animate__fadeOutUp' }
                        });
                        allValid = false;
                    }

                    
                    const securityValidationResult = validatePassword(newPassword);
                    if (!securityValidationResult.isValid) {
                        securityValidationResult.errors.forEach(error => {
                            const p = document.createElement('p');
                            p.textContent = `• ${error}`;
                            passwordSecurityErrorMessagesDiv.appendChild(p);
                        });
                        allValid = false;
                    }

                    
                    if (!allValid) {
                        
                        passwordInput.focus();
                        return; 
                    }

                    try {
                        const response = await fetch('/restore-password', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ token, newPassword, confirmPassword })
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '¡Contraseña Restablecida!',
                                text: data.message || 'Tu contraseña ha sido cambiada exitosamente. Ahora puedes iniciar sesión.',
                                confirmButtonText: 'Ir a Iniciar Sesión',
                                timer: 2000,
                                timerProgressBar: true,
                                showClass: { popup: 'animate__animated animate__fadeInDown' },
                                hideClass: { popup: 'animate__animated animate__fadeOutUp' },
                                didClose: () => {
                                    window.location.href = '/index.html'; 
                                }
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error al Restablecer Contraseña',
                                text: data.message || 'Hubo un problema al cambiar tu contraseña. Inténtalo de nuevo.',
                                confirmButtonText: 'Entendido',
                                showClass: { popup: 'animate__animated animate__shakeX' },
                                hideClass: { popup: 'animate__animated animate__fadeOutUp' }
                            });
                        }

                    } catch (error) {
                        console.error('Error de red o del servidor:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de Conexión',
                            text: 'No se pudo conectar con el servidor. Por favor, verifica tu conexión o inténtalo de nuevo.',
                            confirmButtonText: 'Cerrar',
                            showClass: { popup: 'animate__animated animate__zoomIn' },
                            hideClass: { popup: 'animate__animated animate__zoomOut' }
                        });
                    }
                });
            }

            
            passwordInput.addEventListener('input', () => {
                const password = passwordInput.value;
                const validationResult = validatePassword(password);

                passwordSecurityErrorMessagesDiv.innerHTML = '';
                if (!validationResult.isValid) {
                    validationResult.errors.forEach(error => {
                        const p = document.createElement('p');
                        p.textContent = `• ${error}`;
                        passwordSecurityErrorMessagesDiv.appendChild(p);
                    });
                }
            });

            
            confirmPasswordInput.addEventListener('input', () => {
                const newPassword = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                passwordMismatchErrorDiv.innerHTML = ''; // Limpiar
                if (newPassword !== confirmPassword && confirmPassword !== '') {
                    passwordMismatchErrorDiv.innerHTML = '<p>• Las contraseñas no coinciden.</p>';
                }
            });
        });
    </script>

</body>
</html>